$(document).ready(function () {

    var lat=0;
    var lon=0;
    getLocation();

    // function to call API to get coupons
    function getCoupon(){
        // var results=$(".results")

        // clear the results DIV
        $(".results").empty();

        // creating the parameter for the API call
        // they were generated by www.rapidapi.com
        const settings = {
            "async": true,
            "crossDomain": true,
            "url": "https://kuponiko.p.rapidapi.com/recent/US",
            "method": "GET",
            "headers": {
                "x-rapidapi-key": "8d5bb00771mshf04ccd929144b52p1608fdjsnf4a568afba9b",
                "x-rapidapi-host": "kuponiko.p.rapidapi.com"
            }
        };
        //AJAX call to the API
        $.ajax(settings).done(function (response) {
            //on return, show the data in the webpage
            //dynamically creating the DOM element and placing them in the DIV results
            console.log(response);
            var divCoupon=$("<div>");
            for (i=0;i<25;i++){
                var div=$("<div>");
                // create dynamic button with the store name, click event will be check with attribute DATA-STORE
                var btn=$("<button>").text("store: "+response[i].store_name).attr("data-store",response[i].store_name).addClass("store");
                div.append(btn);
                var p=$("<h4>").text("Coupon Desc.: "+response[i].description);
                div.append(p);
                var p=$("<h4>").text("Coupon Code : "+response[i].code);
                div.append(p);
                divCoupon.append(div);
                };
            $(".results").append(divCoupon);
        });

    };
    
    $("#btnSubmit").click(function(){
        getCoupon();
    });

    $(".results").on("click",".store",function(){
        console.log("before call Function "+$(this).attr("data-store"));
        storeLocator($(this).attr("data-store"));
    });

    function storeLocator(store){
        //  Store API key
        // var storeKey = "T1peEznndyQicqT0mnuGmOLI0QxBfAV";
        var storeKey = "QT1peEznndyQicqT0mnuGmOLI0QxBfAV";

        // QueryURL
        // search Store Name
        console.log("Clicked on button "+store);
        var storeName=store;
        var storeQueryURL = "https://api.tomtom.com/search/2/search/"+storeName+".json?lat="+lat+"&lon="+lon+"&key=" + storeKey;
        // var storeQueryURL = "https://api.tomtom.com/search/2/search/walmart.json?key="+storeKey;

        // nearby Search
        // var storeQueryURL = "https://api.tomtom.com/search/2/nearbySearch/.json?lat="+lat+"&lon="+lon+"&key="+storeKey;
        $.ajax({
            url: storeQueryURL,
            method: "GET"
        }).then(function (response) {
            console.log(response);
        });
    };

    // var x=$("#demo");
    // $("#btnLocation").click(function(){
    //     getLocation();
    // });

    function getLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(showPosition);
        } else { 
          alert("Geolocation is not supported by this browser.");
        };
    };
      
    function showPosition(position) {
        lat=position.coords.latitude;
        lon=position.coords.longitude;
        // x.html("Latitude: " + position.coords.latitude + "<br>Longitude: " + position.coords.longitude);
    };
});